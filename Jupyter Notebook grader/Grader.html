<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook Grader Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.25.7/babel.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script type="module">
        // Firebase App (the core Firebase SDK) is always required and must be listed first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        // Add SDKs for Firebase products that you want to use
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            signInWithCustomToken,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, onSnapshot, updateDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

        // Make Firebase functions globally available for the Babel script
        window.firebase = {
            initializeApp,
            auth: {
                getAuth,
                onAuthStateChanged,
                signOut,
                signInWithCustomToken,
                createUserWithEmailAndPassword,
                signInWithEmailAndPassword,
                sendPasswordResetEmail,
                GoogleAuthProvider,
                signInWithPopup
            },
            firestore: { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, onSnapshot, updateDoc, serverTimestamp, setLogLevel }
        };
        // Make PDFLib globally available
        window.PDFLib = PDFLib;
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        button:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        .notebook-preview {
            max-height: 300px;
            overflow: auto;
            border: 1px solid #e5e7eb; /* light gray */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
            background-color: #f9fafb; /* bg-gray-50 */
        }
        /* Dark mode specific styles */
        @media (prefers-color-scheme: dark) {
            body { background-color: #111827; /* gray-900 */ }
            .bg-gray-100 { background-color: #1f2937; /* gray-800 */ }
            .text-gray-600 { color: #9ca3af; /* gray-400 */ }
            .bg-white { background-color: #1f2937; color: #e5e7eb; }
            .text-gray-800 { color: #f3f4f6; /* gray-100 */ }
            .text-gray-900 { color: #f9fafb; /* gray-50 */ }
            .border-gray-200 { border-color: #374151; /* gray-700 */ }
            .border-gray-300 { border-color: #4b5563; /* gray-600 */ }
            .bg-red-100 { background-color: #450a0a; }
            .text-red-600 { color: #fca5a5; /* red-300 */ }
            .text-red-700 { color: #f87171; /* red-400 */ }
            .bg-green-100 { background-color: #064e3b; }
            .text-green-600 { color: #6ee7b7; /* green-300 */ }
            .text-green-700 { color: #34d399; /* green-400 */ }
            .bg-yellow-100 { background-color: #78350f; }
            .text-yellow-600 { color: #fde047; /* yellow-300 */ }
            .text-yellow-700 { color: #facc15; /* yellow-400 */ }
            .bg-blue-100 { background-color: #1e3a8a; }
            .text-blue-700 { color: #60a5fa; /* blue-400 */ }
            .notebook-preview {
                background-color: #1f2937;
                border-color: #374151;
            }
            .bg-gray-50 { background-color: #374151; }
            .hover\:bg-gray-50:hover { background-color: #4b5563; }
            .dark\:bg-gray-700 { background-color: #374151; }
            .dark\:bg-gray-800 { background-color: #1f2937; }
            .dark\:text-gray-100 { color: #f3f4f6; }
            .dark\:text-gray-300 { color: #d1d5db; }
            .dark\:text-gray-400 { color: #9ca3af; }
            .dark\:border-gray-600 { border-color: #4b5563; }
            .dark\:border-gray-700 { border-color: #374151; }
            .dark\:hover\:bg-gray-600:hover { background-color: #4b5563;}
            .dark\:hover\:bg-gray-700:hover { background-color: #374151;}
            .dark\:bg-red-900 { background-color: #7f1d1d; }
            .dark\:text-red-300 { color: #fca5a5; }
            .dark\:bg-green-900 { background-color: #065f46; }
            .dark\:text-green-300 { color: #6ee7b7; }
            .dark\:bg-yellow-900 { background-color: #92400e; }
            .dark\:text-yellow-300 { color: #fcd34d; }
            .dark\:bg-blue-900 { background-color: #1e40af; }
            .dark\:text-blue-300 { color: #93c5fd; }
            .dark\:text-blue-400 { color: #60a5fa; }
            .dark\:text-indigo-400 { color: #a5b4fc; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        // Ensure React and ReactDOM are available
        const React = window.React; 
        const { useState, useEffect, useCallback, useRef, Component, StrictMode } = React; 
        const { createRoot } = window.ReactDOM;

        // Firebase functions from global window object
        const { initializeApp } = window.firebase;
        const { 
            getAuth, 
            onAuthStateChanged, 
            signOut, 
            signInWithCustomToken,
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            sendPasswordResetEmail, 
            GoogleAuthProvider, 
            signInWithPopup 
        } = window.firebase.auth;
        const { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, onSnapshot, updateDoc, serverTimestamp, setLogLevel } = window.firebase.firestore;
        const { PDFDocument, rgb, StandardFonts } = window.PDFLib; 


        // Firebase Configuration with fallback
        const firebaseConfigFromHost = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : null;
        const firebaseConfig = firebaseConfigFromHost || {
            apiKey: "AIzaSyA-KEK3hUGTXgaC6QC2Fzam40HKgRpqOn8",
            authDomain: "jupyter-grader-864f1.firebaseapp.com",
            projectId: "jupyter-grader-864f1",
            storageBucket: "jupyter-grader-864f1.firebasestorage.app",
            messagingSenderId: "112154005699",
            appId: "1:112154005699:web:953891af7f691054311276",
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-jupyter-platform';

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); 
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            const rootElement = document.getElementById('root');
            if (rootElement) {
                rootElement.innerHTML = `<div class="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6 text-center">
                    <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-300 px-6 py-4 rounded-lg shadow-lg max-w-md w-full">
                        <strong class="font-bold block mb-2">Initialization Error:</strong>
                        <p>Could not connect to essential services. Please check your internet connection and try refreshing the page.</p>
                    </div>
                     <button onclick="window.location.reload()" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md transition-all">
                        Refresh Page
                    </button>
                </div>`;
            }
        }

        // Error Boundary Component
        class ErrorBoundary extends Component { 
            state = { error: null, errorInfo: null };
            static getDerivedStateFromError(error) { return { error: error }; }
            componentDidCatch(error, errorInfo) {
                this.setState({ errorInfo: errorInfo });
                console.error("ErrorBoundary caught an error:", error, errorInfo);
            }
            render() {
                if (this.state.error) {
                    return (
                        <div className="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6 text-center">
                            <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-300 px-6 py-4 rounded-lg shadow-lg max-w-md w-full">
                                <strong className="font-bold block mb-2 text-lg">Application Error</strong>
                                <p className="mb-3 text-sm">{this.state.error.toString()}</p>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mb-4">Please try refreshing the page.</p>
                                {this.state.errorInfo && (
                                    <details className="text-left text-xs mt-2 p-2 bg-gray-200 dark:bg-gray-700 rounded">
                                        <summary className="cursor-pointer font-medium">Error Details</summary>
                                        <pre className="mt-1 whitespace-pre-wrap break-all">{this.state.errorInfo.componentStack}</pre>
                                    </details>
                                )}
                            </div>
                            <button onClick={() => window.location.reload()} className="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md transition-all" aria-label="Refresh application">Refresh Page</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Helper Components
        const Modal = ({ isOpen, onClose, title, children }) => {
            const modalRef = useRef(null);
            useEffect(() => { if (isOpen) modalRef.current?.focus(); }, [isOpen]);
            useEffect(() => {
                const handleEsc = (event) => { if (event.key === 'Escape') onClose(); };
                if (isOpen) document.addEventListener('keydown', handleEsc);
                return () => document.removeEventListener('keydown', handleEsc);
            }, [isOpen, onClose]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 animate-fade-in" onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}>
                    <div ref={modalRef} className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg transition-all max-h-[90vh] overflow-y-auto" tabIndex={-1} role="dialog" aria-modal="true" aria-labelledby="modal-title">
                        <div className="flex justify-between items-center mb-6">
                            <h3 id="modal-title" className="text-2xl font-semibold text-gray-900 dark:text-gray-100">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-3xl leading-none p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Close modal">&times;</button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        const Spinner = ({ size = 10, color = 'border-blue-600' }) => (
            <div className="flex justify-center items-center">
                <div className={`animate-spin rounded-full border-t-2 border-b-2 ${color}`} style={{ width: `${size}px`, height: `${size}px` }} role="status" aria-label="Loading..."><span className="sr-only">Loading...</span></div>
            </div>
        );

        const StatusBadge = ({ status }) => {
            let bgClass, textClass, dotClass;
            switch(status?.toLowerCase()) { 
                case 'graded': bgClass = 'bg-green-100 dark:bg-green-900'; textClass = 'text-green-700 dark:text-green-300'; dotClass = 'bg-green-500'; break;
                case 'submitted': bgClass = 'bg-yellow-100 dark:bg-yellow-900'; textClass = 'text-yellow-700 dark:text-yellow-300'; dotClass = 'bg-yellow-500'; break;
                case 'in-progress': bgClass = 'bg-blue-100 dark:bg-blue-900'; textClass = 'text-blue-700 dark:text-blue-300'; dotClass = 'bg-blue-500'; break;
                default: bgClass = 'bg-gray-200 dark:bg-gray-700'; textClass = 'text-gray-700 dark:text-gray-300'; dotClass = 'bg-gray-500';
            }
            return (<span className={`inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full ${bgClass} ${textClass}`}><span className={`w-2 h-2 mr-2 rounded-full ${dotClass}`}></span>{status?.toUpperCase() || 'UNKNOWN'}</span>);
        };

        // AuthScreen Component
        const AuthScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);
            const [passwordVisible, setPasswordVisible] = useState(false);
            const [resetEmailSent, setResetEmailSent] = useState(false);
            const emailInputRef = useRef(null);
            useEffect(() => { emailInputRef.current?.focus(); }, []);
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email || !password) { setError("Email and password are required."); return; }
                setLoading(true); setError(null);
                try {
                    if (isSignUp) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    console.error("Auth error:", err);
                    let friendlyMessage = "An error occurred. Please try again.";
                    if (err.code) {
                        switch (err.code) {
                            case 'auth/invalid-email': friendlyMessage = "Please enter a valid email address."; break;
                            case 'auth/user-not-found': case 'auth/wrong-password': friendlyMessage = "Invalid email or password."; break;
                            case 'auth/email-already-in-use': friendlyMessage = "This email is already registered."; break;
                            case 'auth/weak-password': friendlyMessage = "Password should be at least 6 characters long."; break;
                            case 'auth/network-request-failed': friendlyMessage = "Network error. Check connection."; break;
                            case 'auth/operation-not-allowed': friendlyMessage = "Auth method not enabled in Firebase."; break;
                            default: friendlyMessage = err.message;
                        }
                    }
                    setError(friendlyMessage);
                }
                setLoading(false);
            };
            const handleGoogleSignIn = async () => {
                setLoading(true); setError(null);
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    console.error("Google Sign-in error:", err);
                    let friendlyMessage = "Could not sign in with Google.";
                    if (err.code === 'auth/popup-closed-by-user') friendlyMessage = "Google sign-in window closed.";
                    else if (err.code === 'auth/cancelled-popup-request') friendlyMessage = "Another sign-in request was in progress.";
                    else if (err.code === 'auth/operation-not-allowed') friendlyMessage = "Google sign-in not enabled in Firebase.";
                    setError(friendlyMessage);
                }
                setLoading(false);
            };
            const handleForgotPassword = async () => {
                if (!email) { setError("Please enter email to reset password."); return; }
                setLoading(true); setError(null); setResetEmailSent(false);
                try {
                    await sendPasswordResetEmail(auth, email);
                    setResetEmailSent(true); setError(null); 
                } catch (err) {
                    console.error("Password reset error:", err);
                    let friendlyMessage = "Could not send password reset email.";
                    if (err.code === 'auth/invalid-email') friendlyMessage = "Please enter a valid email.";
                    else if (err.code === 'auth/user-not-found') friendlyMessage = "No user found with that email.";
                    else if (err.code === 'auth/operation-not-allowed') friendlyMessage = "Password reset not enabled in Firebase.";
                    setError(friendlyMessage);
                }
                setLoading(false);
            };
            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex flex-col items-center justify-center p-4">
                    <div className="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md animate-fade-in">
                        <h2 className="text-3xl font-bold text-center text-gray-900 dark:text-gray-100 mb-8">{isSignUp ? 'Create Account' : 'Sign In'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700 dark:text-gray-300">Email address</label>
                                <input ref={emailInputRef} id="email" name="email" type="email" autoComplete="email" required value={email} onChange={(e) => { setEmail(e.target.value); setError(null); setResetEmailSent(false); }} className="mt-1 block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100" placeholder="your.email@example.com" aria-invalid={!!error} />
                            </div>
                            <div className="relative">
                                <label htmlFor="password" className="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                                <input id="password" name="password" type={passwordVisible ? 'text' : 'password'} autoComplete={isSignUp ? 'new-password' : 'current-password'} required value={password} onChange={(e) => { setPassword(e.target.value); setError(null); }} className="mt-1 block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100 pr-10" placeholder="••••••••" aria-invalid={!!error} />
                                <button type="button" onClick={() => setPasswordVisible(!passwordVisible)} className="absolute inset-y-0 right-0 pr-3 flex items-center pt-6 text-sm leading-5" aria-label={passwordVisible ? "Hide password" : "Show password"}>
                                    {passwordVisible ? (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.879 16.121A4.99 4.99 0 0112 17c.532 0 1.05-.098 1.53-.284m-9.75-9.75L9.543 2m6.732 6.732l1.563 1.563m-5.858.908a3 3 0 114.243 4.243M9.879 16.121A4.99 4.99 0 0112 17c.532 0 1.05-.098 1.53-.284m-9.75-9.75L9.543 2m6.732 6.732l1.563 1.563" /></svg>) : (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>)}
                                </button>
                            </div>
                            {error && <p className="text-sm text-red-600 dark:text-red-300 -mt-3" role="alert">{error}</p>}
                            {resetEmailSent && <p className="text-sm text-green-600 dark:text-green-300 -mt-3">Password reset email sent! Check your inbox.</p>}
                            <button type="submit" className="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-md shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800 transition-colors" disabled={loading}>
                                {loading ? <Spinner size={20} color="border-white" /> : (isSignUp ? 'Sign Up' : 'Sign In')}
                            </button>
                        </form>
                        <div className="mt-6">
                            <button type="button" onClick={handleGoogleSignIn} className="w-full flex items-center justify-center py-2.5 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-lg font-semibold text-gray-800 dark:text-gray-100 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800 transition-colors" disabled={loading}>
                                {loading && <span className="mr-2"><Spinner size={20} color="border-gray-700 dark:border-gray-100" /></span>}
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" className="h-6 w-6 mr-3" />
                                Sign {isSignUp ? 'Up' : 'In'} with Google
                            </button>
                        </div>
                        <div className="mt-6 text-center text-sm">
                            <button type="button" onClick={() => setIsSignUp(!isSignUp)} className="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 transition-colors" disabled={loading}>
                                {isSignUp ? 'Already have an account? Sign In' : 'Don\'t have an account? Sign Up'}
                            </button>
                        </div>
                        {!isSignUp && (<div className="mt-4 text-center text-sm"><button type="button" onClick={handleForgotPassword} className="font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300 transition-colors" disabled={loading}>Forgot Password?</button></div>)}
                    </div>
                </div>
            );
        };

        // Main Application
        function App() {
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [isLoading, setIsLoading] = useState(true); 
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!auth || !db) {
                    console.error("Firebase services not available in App useEffect.");
                    setError("Essential services are not available. Please refresh.");
                    setIsLoading(false); setIsAuthReady(true); return;
                }
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setIsLoading(true); 
                    if (currentUser) {
                        setUser(currentUser);
                        const currentUid = currentUser.uid;
                        setUserId(currentUid);
                        try {
                            const roleDocRef = doc(db, `artifacts/${appId}/public/data/user_roles/${currentUid}`);
                            const roleDocSnap = await getDoc(roleDocRef);
                            if (roleDocSnap.exists()) setUserRole(roleDocSnap.data().role);
                            else setUserRole(null); 
                            setError(null); 
                        } catch (e) { console.error("Error fetching user role:", e); setError("Could not fetch user role."); setUserRole(null); }
                    } else {
                        setUser(null); setUserId(null); setUserRole(null);
                        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialToken) { try { await signInWithCustomToken(auth, initialToken); } catch (e) { console.error("Error custom token sign-in:", e);}}
                    }
                    setIsAuthReady(true); setIsLoading(false); 
                }, (authError) => {
                    console.error("Auth state change error:", authError);
                    setError("Authentication error. Please refresh.");
                    setIsAuthReady(true); setIsLoading(false);
                });
                return () => unsubscribe(); 
            }, [appId]);

            const handleRoleSelect = async (role) => {
                if (!user || !userId || !db) { setError("User not authenticated or DB unavailable."); return; }
                setIsLoading(true);
                try {
                    const roleDocRef = doc(db, `artifacts/${appId}/public/data/user_roles/${userId}`);
                    await setDoc(roleDocRef, { role, userId, email: user.email || `${userId}@example.com`, createdAt: serverTimestamp(), lastActive: serverTimestamp() });
                    setUserRole(role); setError(null); 
                } catch (e) { console.error("Error setting user role:", e); setError("Failed to set user role."); }
                setIsLoading(false);
            };

            const handleLogout = async () => {
                if (!auth) { setError("Auth service unavailable for logout."); return; }
                setIsLoading(true);
                try { await signOut(auth); } catch (e) { console.error("Error signing out:", e); setError("Logout failed."); setIsLoading(false); }
            };

            if (!isAuthReady) return (<div className="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6"><Spinner size={48} /><p className="text-gray-600 dark:text-gray-300 mt-4 text-lg">Initializing Authentication...</p></div>);
            if (isLoading) return (<div className="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6"><Spinner size={48} /><p className="text-gray-600 dark:text-gray-300 mt-4 text-lg">Loading data...</p></div>);
            if (error) return (<div className="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6 text-center"><div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-300 px-6 py-4 rounded-lg shadow-lg max-w-md w-full"><strong className="font-bold block mb-2 text-lg">Application Error</strong><p className="text-sm">{error}</p></div><button onClick={() => window.location.reload()} className="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md transition-all" aria-label="Refresh application">Refresh Page</button></div>);
            if (!user) return <AuthScreen />;
            if (user && !userRole) return <RoleSelectionScreen onSelectRole={handleRoleSelect} isLoading={isLoading} />;
            if (user && userRole) return (<div className="min-h-screen bg-gray-100 dark:bg-gray-900"><Navbar userRole={userRole} userId={userId} onLogout={handleLogout} /><main className="container mx-auto p-4 md:p-6 lg:p-8">{userRole === 'student' && <StudentDashboard userId={userId} userEmail={user.email || `${userId}@example.com`} isAuthReady={isAuthReady} />}{userRole === 'grader' && <GraderDashboard userId={userId} isAuthReady={isAuthReady} />}</main></div>);
            return (<div className="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6"><p className="text-gray-600 dark:text-gray-300 text-lg">An unexpected state occurred. Please refresh.</p></div>);
        }

        // Role Selection Screen
        const RoleSelectionScreen = ({ onSelectRole, isLoading }) => (
            <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-700 flex flex-col items-center justify-center p-4">
                <div className="bg-white dark:bg-gray-800 bg-opacity-95 dark:bg-opacity-95 backdrop-blur-md p-6 md:p-10 rounded-2xl shadow-2xl text-center max-w-lg w-full animate-fade-in">
                    <h1 className="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100 mb-6">Welcome to Notebook Grader</h1>
                    <p className="mb-8 text-base md:text-lg text-gray-700 dark:text-gray-300">Please select your role to continue:</p>
                    <div className="flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-4 justify-center">
                        <button onClick={() => onSelectRole('student')} disabled={isLoading} className="w-full sm:w-auto flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-60 disabled:hover:scale-100 disabled:cursor-not-allowed" aria-label="Select Student Role">{isLoading ? <Spinner size={20} color="border-white"/> : 'I am a Student'}</button>
                        <button onClick={() => onSelectRole('grader')} disabled={isLoading} className="w-full sm:w-auto flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 disabled:opacity-60 disabled:hover:scale-100 disabled:cursor-not-allowed" aria-label="Select Grader Role">{isLoading ? <Spinner size={20} color="border-white"/> : 'I am a Grader'}</button>
                    </div>
                    <p className="mt-8 text-sm text-gray-200 dark:text-gray-400">Your role selection will determine your access and permissions.</p>
                </div>
            </div>
        );

        // Navbar
        const Navbar = ({ userRole, userId, onLogout }) => (
            <nav className="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
                <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        <div className="flex items-center"><span className="font-bold text-xl md:text-2xl text-blue-600 dark:text-blue-400">Notebook Grader</span></div>
                        <div className="flex items-center space-x-3 md:space-x-4">
                            <div className="text-xs md:text-sm text-gray-600 dark:text-gray-300 hidden sm:flex items-center space-x-2"><span>Role:</span> <StatusBadge status={userRole} /></div>
                            {userId && (<div className="hidden md:flex items-center space-x-1 text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-md"><span>ID:</span><span className="font-mono" title={userId}>{userId.substring(0, 8)}...</span></div>)}
                            <button onClick={onLogout} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" aria-label="Logout">Logout</button>
                        </div>
                    </div>
                    <div className="flex items-center justify-between pb-2 sm:hidden border-t border-gray-200 dark:border-gray-700 mt-2 pt-2">
                         <div className="text-xs text-gray-600 dark:text-gray-300 flex items-center space-x-2"><span>Role:</span> <StatusBadge status={userRole} /></div>
                        {userId && (<div className="flex items-center space-x-1 text-xs text-gray-500 dark:text-gray-400"><span>ID:</span><span className="font-mono" title={userId}>{userId.substring(0, 8)}...</span></div>)}
                    </div>
                </div>
            </nav>
        );
        
        // --- Certificate Generation Logic ---
        // Helper function to fetch image and convert to ArrayBuffer
        async function fetchImageAsArrayBuffer(url) {
            console.log("fetchImageAsArrayBuffer called for URL:", url); // Log URL
            try {
                const response = await fetch(url);
                console.log("Fetch response status:", response.status, response.statusText); // Log status
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                console.log("Image data converted to ArrayBuffer successfully."); // Log success
                return arrayBuffer;
            } catch (e) {
                console.error("Error fetching image in fetchImageAsArrayBuffer:", e); // Log error
                throw e; 
            }
        }

        async function createPdfCertificate(studentName, date) {
            console.log("Starting PDF certificate generation..."); // Log start
            try {
                const pdfDoc = await PDFDocument.create();
                const page = pdfDoc.addPage([841.89, 595.28]); 
                const { width, height } = page.getSize();

                const helveticaBoldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
                const timesRomanItalicFont = await pdfDoc.embedFont(StandardFonts.TimesRomanItalic); 
                const timesRomanFont = await pdfDoc.embedFont(StandardFonts.TimesRoman);

                // Set background to white
                page.drawRectangle({ x: 0, y: 0, width, height, color: rgb(1, 1, 1) }); 
                
                // Border (SteelBlue) - Kept for structure, can be removed if a pure white background is desired with no border
                page.drawRectangle({ x: 20, y: 20, width: width - 40, height: height - 40, borderColor: rgb(0.27, 0.51, 0.71), borderWidth: 5 });

                const logoImageUrl = "https://raw.githubusercontent.com/Moleboge98/Moleboge98/main/Call%20for%20Application%20for%20the%20Data%20Analytics%20(17).png";
                console.log("Attempting to fetch logo from URL:", logoImageUrl); 
                let logoImageHeight = 0;
                const logoTopMargin = 40;

                try {
                    const imageArrayBuffer = await fetchImageAsArrayBuffer(logoImageUrl);
                    console.log("Logo image data fetched, type:", imageArrayBuffer ? imageArrayBuffer.constructor.name : "null"); 
                    
                    const embeddedLogoImage = await pdfDoc.embedPng(imageArrayBuffer); 
                    console.log("Logo image embedded into PDF. Dimensions:", embeddedLogoImage.width, "x", embeddedLogoImage.height); 
                    
                    const desiredLogoWidth = 250; 
                    const scale = desiredLogoWidth / embeddedLogoImage.width;
                    logoImageHeight = embeddedLogoImage.height * scale;
                    
                    page.drawImage(embeddedLogoImage, {
                        x: (width - desiredLogoWidth) / 2,
                        y: height - logoTopMargin - logoImageHeight,
                        width: desiredLogoWidth,
                        height: logoImageHeight,
                    });
                    console.log("Logo image drawn on PDF page."); 
                } catch (e) {
                    console.error("Could not load or embed logo image into PDF:", e); 
                    page.drawText('Logo Error', { x: (width - helveticaFont.widthOfTextAtSize('Logo Error', 12)) / 2, y: height - logoTopMargin - 20, size: 12, font: helveticaFont, color: rgb(0.8, 0.2, 0.2) });
                    logoImageHeight = 30; 
                }

                let currentY = height - logoTopMargin - logoImageHeight - 50; 

                const titleText = 'Certificate of Completion';
                const titleFontSize = 28;
                const titleWidth = helveticaBoldFont.widthOfTextAtSize(titleText, titleFontSize);
                page.drawText(titleText, { x: (width - titleWidth) / 2, y: currentY, size: titleFontSize, font: helveticaBoldFont, color: rgb(0.1, 0.2, 0.45) });
                currentY -= 50;

                const certifiesText = 'This certifies that';
                const certifiesFontSize = 14;
                const certifiesWidth = helveticaFont.widthOfTextAtSize(certifiesText, certifiesFontSize);
                page.drawText(certifiesText, { x: (width - certifiesWidth) / 2, y: currentY, size: certifiesFontSize, font: helveticaFont, color: rgb(0.2, 0.2, 0.2) });
                currentY -= 50;

                const studentNameFontSize = 32;
                const studentNameWidth = timesRomanFont.widthOfTextAtSize(studentName, studentNameFontSize);
                page.drawText(studentName, { x: (width - studentNameWidth) / 2, y: currentY, size: studentNameFontSize, font: timesRomanFont, color: rgb(0.1, 0.1, 0.1) });
                currentY -= 40;
                
                const courseTextLine1 = "has successfully completed the";
                const courseTextLine2 = "BRICS Astronomy & IDIA Data Analytics Training Course";
                const courseFontSize = 16;
                const courseTextLine1Width = helveticaFont.widthOfTextAtSize(courseTextLine1, courseFontSize);
                page.drawText(courseTextLine1, { x: (width - courseTextLine1Width) / 2, y: currentY, size: courseFontSize, font: helveticaFont, color: rgb(0.2, 0.2, 0.2) });
                currentY -= (courseFontSize + 5);
                const courseTextLine2Width = helveticaBoldFont.widthOfTextAtSize(courseTextLine2, courseFontSize);
                page.drawText(courseTextLine2, { x: (width - courseTextLine2Width) / 2, y: currentY, size: courseFontSize, font: helveticaBoldFont, color: rgb(0.1, 0.2, 0.45) });
                currentY -= 60;

                const dateText = `Date: ${date}`;
                const dateFontSize = 12;
                const dateWidth = helveticaFont.widthOfTextAtSize(dateText, dateFontSize);
                page.drawText(dateText, { x: (width - dateWidth) / 2, y: currentY, size: dateFontSize, font: helveticaFont, color: rgb(0.33, 0.33, 0.33) });
                currentY -= 70;

                const signatureName = "D. Kubheka";
                const signatureFontSize = 18;
                const signatureNameWidth = timesRomanItalicFont.widthOfTextAtSize(signatureName, signatureFontSize);
                const signatureBlockX = width / 2;
                const signatureLineY = currentY;
                const signatureLineWidth = 200;
                page.drawLine({ start: { x: signatureBlockX - signatureLineWidth / 2, y: signatureLineY }, end: { x: signatureBlockX + signatureLineWidth / 2, y: signatureLineY }, thickness: 1, color: rgb(0.2, 0.2, 0.2) });
                currentY -= 5;
                page.drawText(signatureName, {  x: signatureBlockX - signatureNameWidth / 2, y: signatureLineY + 5, size: signatureFontSize, font: timesRomanItalicFont, color: rgb(0.1, 0.1, 0.1) });
                currentY -= (signatureFontSize + 5);
                const printedNameText = "Duduzile Kubheka";
                const printedNameFontSize = 11;
                const printedNameWidth = helveticaFont.widthOfTextAtSize(printedNameText, printedNameFontSize);
                page.drawText(printedNameText, { x: signatureBlockX - printedNameWidth / 2, y: currentY, size: printedNameFontSize, font: helveticaFont, color: rgb(0.2, 0.2, 0.2) });
                currentY -= (printedNameFontSize + 3);
                const titleCoordinatorText = "BRICS Astronomy Project Coordinator";
                const titleCoordinatorFontSize = 10;
                const titleCoordinatorWidth = helveticaFont.widthOfTextAtSize(titleCoordinatorText, titleCoordinatorFontSize);
                page.drawText(titleCoordinatorText, { x: signatureBlockX - titleCoordinatorWidth / 2, y: currentY, size: titleCoordinatorFontSize, font: helveticaFont, color: rgb(0.3, 0.3, 0.3) });

                console.log("PDF content drawn. Saving PDF..."); 
                const pdfBytes = await pdfDoc.save();
                console.log("PDF saved to bytes. Triggering download."); 
                return pdfBytes;

            } catch (e) {
                console.error("Critical error in createPdfCertificate function:", e); 
                alert(`Failed to generate certificate: ${e.message}. Check console for details.`);
                throw e; 
            }
        }

        const downloadPdf = (pdfBytes, filename) => {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        };
        // --- End Certificate Generation Logic ---


        // Student Dashboard
        const StudentDashboard = ({ userId, userEmail, isAuthReady }) => {
            const [submissions, setSubmissions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [stats, setStats] = useState({ total: 0, graded: 0, average: 0 });
            const [isGeneratingCert, setIsGeneratingCert] = useState(null); 

            useEffect(() => {
                if (!isAuthReady || !db || !userId) {
                    if (isAuthReady && !db) setError("Database service unavailable.");
                    setIsLoading(false); return;
                }
                setIsLoading(true);
                const q = query(collection(db, `artifacts/${appId}/public/data/submissions`), where("studentId", "==", userId));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const subs = []; let gradedCount = 0, sumOfGrades = 0;
                    querySnapshot.forEach((doc) => {
                        const data = { id: doc.id, ...doc.data() };
                        subs.push(data);
                        if (data.status === 'graded' && data.grade !== null && !isNaN(parseFloat(data.grade))) {
                            gradedCount++; sumOfGrades += parseFloat(data.grade);
                        }
                    });
                    subs.sort((a, b) => (b.submittedAt?.toDate()?.getTime() || 0) - (a.submittedAt?.toDate()?.getTime() || 0));
                    setSubmissions(subs);
                    const totalSubmissions = subs.length;
                    const averageGrade = gradedCount > 0 ? (sumOfGrades / gradedCount).toFixed(1) : 0;
                    setStats({ total: totalSubmissions, graded: gradedCount, average: averageGrade });
                    setIsLoading(false); setError(null);
                }, (err) => { console.error("Error fetching student submissions:", err); setError("Failed to load submissions."); setIsLoading(false); });
                return () => unsubscribe();
            }, [userId, isAuthReady, db, appId]);

            const handleDownloadCertificate = async (submission) => {
                if (!submission.certificateEligible || !submission.fullNameForCertificate) {
                    alert("Certificate is not available or full name is missing."); return;
                }
                setIsGeneratingCert(submission.id);
                try {
                    const gradeDate = submission.gradedAt?.toDate() ? new Date(submission.gradedAt.toDate()).toLocaleDateString() : new Date().toLocaleDateString();
                    // Note: assignmentTitle is removed from createPdfCertificate call
                    const pdfBytes = await createPdfCertificate(submission.fullNameForCertificate, gradeDate);
                    downloadPdf(pdfBytes, `Certificate_${submission.fullNameForCertificate.replace(/ /g, '_')}.pdf`);
                } catch (e) {
                    console.error("Failed to download certificate:", e);
                    // Alert is now handled within createPdfCertificate for critical errors
                } finally {
                    setIsGeneratingCert(null);
                }
            };

            if (!isAuthReady || !db) return (<div className="text-center p-10"><div className="mb-4"><Spinner size={32} /></div><p className="text-gray-600 dark:text-gray-300">Waiting for essential services...</p></div>);
            
            return (
                <div className="space-y-6 md:space-y-8 animate-fade-in">
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 p-4 bg-white dark:bg-gray-800 shadow rounded-lg">
                        <div>
                            <h2 className="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">My Submissions</h2>
                            <p className="text-gray-600 dark:text-gray-400 text-sm mt-1">{stats.total} assignments submitted &bull; {stats.graded} graded &bull; Average Grade: {stats.average > 0 ? stats.average : 'N/A'}</p>
                        </div>
                        <button onClick={() => setIsFormOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md transition-all whitespace-nowrap focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" aria-label="Submit New Notebook">+ New Submission</button>
                    </header>
                    {isFormOpen && (<NewSubmissionForm userId={userId} userEmail={userEmail} onClose={() => setIsFormOpen(false)} appId={appId} db={db} />)}
                    {isLoading && <div className="text-center py-10"><Spinner size={32} /></div>}
                    {error && (<div className="text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900 p-4 rounded-lg shadow text-center">{error}</div>)}
                    {!isLoading && !error && submissions.length === 0 && (
                        <div className="text-center py-16 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                            <div className="text-gray-400 dark:text-gray-500 mb-6"><svg xmlns="http://www.w3.org/2000/svg" className="h-20 w-20 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                            <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">No submissions yet!</h3>
                            <p className="text-gray-600 dark:text-gray-400 max-w-md mx-auto mb-6">Click "+ New Submission" to get started.</p>
                        </div>
                    )}
                    {!isLoading && !error && submissions.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 shadow-xl rounded-lg overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead className="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Assignment/Course</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Grade</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Submitted</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Certificate</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    {submissions.map(sub => (
                                        <React.Fragment key={sub.id}>
                                            <tr className="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="font-semibold text-blue-600 dark:text-blue-400">{sub.assignmentTitle}</div>
                                                    <div className="text-sm text-gray-500 dark:text-gray-400 truncate max-w-xs"><a href={sub.notebookLink} target="_blank" rel="noopener noreferrer" className="hover:underline" title={sub.notebookLink}>{sub.notebookLink || "No link"}</a></div>
                                                    <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Name for Cert: {sub.fullNameForCertificate || 'N/A'}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap"><StatusBadge status={sub.status} /></td>
                                                <td className="px-6 py-4 whitespace-nowrap">{sub.status === 'graded' && sub.grade !== null ? (<p className="text-lg font-bold text-green-600 dark:text-green-400">{sub.grade}</p>) : (<p className="text-gray-500 dark:text-gray-400">-</p>)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{sub.submittedAt?.toDate() ? new Date(sub.submittedAt.toDate()).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A'}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    {sub.certificateEligible && parseFloat(sub.grade) >= 50 ? (
                                                        <button onClick={() => handleDownloadCertificate(sub)} disabled={isGeneratingCert === sub.id} className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-lg text-xs shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50">
                                                            {isGeneratingCert === sub.id ? <Spinner size={16} color="border-white"/> : 'Download Cert'}
                                                        </button>
                                                    ) : (<p className="text-xs text-gray-400 dark:text-gray-500">{sub.status === 'graded' && parseFloat(sub.grade) < 50 ? 'Grade < 50' : 'Not eligible'}</p>)}
                                                </td>
                                            </tr>
                                            {sub.status === 'graded' && sub.feedback && (<tr className="bg-gray-50 dark:bg-gray-700/30"><td colSpan="5" className="px-6 py-3"><div className="p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600"><p className="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1">Feedback:</p><p className="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap">{sub.feedback}</p></div></td></tr>)}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // New Submission Form
        const NewSubmissionForm = ({ userId, userEmail, onClose, appId, db }) => { 
            const [assignmentTitle, setAssignmentTitle] = useState('');
            const [notebookLink, setNotebookLink] = useState('');
            const [fullNameForCertificate, setFullNameForCertificate] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [error, setError] = useState(null);
            const [successMessage, setSuccessMessage] = useState(null);
            const titleInputRef = useRef(null);
            useEffect(() => { titleInputRef.current?.focus(); }, []);
            const handleSubmit = async (e) => {
                e.preventDefault(); setError(null);
                if (!assignmentTitle.trim()) { setError("Assignment title is required."); return; }
                if (!notebookLink.trim()) { setError("Notebook link is required."); return; }
                if (!fullNameForCertificate.trim()) { setError("Full name for certificate is required."); return; }
                try { new URL(notebookLink.trim()); } catch (_) { setError("Please enter a valid URL for the notebook link."); return; }
                if (!userId || !db) { setError("User or database service unavailable."); return; }
                setIsSubmitting(true); setSuccessMessage(null);
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/submissions`), {
                        studentId: userId, studentEmail: userEmail || `${userId}@example.com`,
                        assignmentTitle: assignmentTitle.trim(), notebookLink: notebookLink.trim(),
                        fullNameForCertificate: fullNameForCertificate.trim(), status: 'submitted', 
                        submittedAt: serverTimestamp(), grade: null, feedback: null, certificateEligible: false,
                    });
                    setSuccessMessage("Notebook submitted successfully!");
                    setAssignmentTitle(''); setNotebookLink(''); setFullNameForCertificate('');
                    setTimeout(() => { setSuccessMessage(null); onClose(); }, 2000);
                } catch (err) { console.error("Error submitting notebook:", err); setError(`Failed to submit notebook: ${err.message}.`); }
                setIsSubmitting(false);
            };
            return (
                <Modal isOpen={true} onClose={onClose} title="Submit New Notebook">
                    <form onSubmit={handleSubmit} className="space-y-5">
                        <div>
                            <label htmlFor="assignmentTitle" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Assignment Title (e.g., Week 1 Project)</label>
                            <input ref={titleInputRef} type="text" id="assignmentTitle" value={assignmentTitle} onChange={(e) => setAssignmentTitle(e.target.value)} className="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-colors" placeholder="e.g., Lab 1: Data Analysis" required aria-required="true"/>
                        </div>
                        <div>
                            <label htmlFor="notebookLink" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notebook Link</label>
                            <input type="url" id="notebookLink" value={notebookLink} onChange={(e) => setNotebookLink(e.target.value)} className="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-colors" placeholder="https://colab.research.google.com/..." required aria-required="true"/>
                            <p className="mt-1.5 text-xs text-gray-500 dark:text-gray-400">Ensure the link is publicly accessible for grading.</p>
                        </div>
                        <div>
                            <label htmlFor="fullNameForCertificate" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name for Certificate</label>
                            <input type="text" id="fullNameForCertificate" value={fullNameForCertificate} onChange={(e) => setFullNameForCertificate(e.target.value)} className="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-colors" placeholder="e.g., Jane Doe" required aria-required="true"/>
                            <p className="mt-1.5 text-xs text-yellow-600 dark:text-yellow-400"><strong className="font-semibold">Important:</strong> This name will be on your certificate. It cannot be changed later.</p>
                        </div>
                        {error && <div className="text-sm text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900 p-3 rounded-lg shadow">{error}</div>}
                        {successMessage && <div className="text-sm text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900 p-3 rounded-lg shadow">{successMessage}</div>}
                        <div className="flex justify-end space-x-3 pt-3 border-t border-gray-200 dark:border-gray-700 mt-6">
                            <button type="button" onClick={onClose} disabled={isSubmitting} className="px-5 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-lg border border-gray-300 dark:border-gray-500 shadow-sm transition-colors disabled:opacity-50">Cancel</button>
                            <button type="submit" disabled={isSubmitting} className="px-5 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800 disabled:opacity-60 disabled:cursor-not-allowed min-w-[150px] flex items-center justify-center">{isSubmitting ? <Spinner size={20} color="border-white"/> : 'Submit Notebook'}</button>
                        </div>
                    </form>
                </Modal>
            );
        };

        // Grader Dashboard
        const GraderDashboard = ({ userId, isAuthReady }) => {
            const [submissions, setSubmissions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedSubmission, setSelectedSubmission] = useState(null);
            const [isGradingModalOpen, setIsGradingModalOpen] = useState(false);
            const [filterStatus, setFilterStatus] = useState('submitted'); 
            const [stats, setStats] = useState({ total: 0, submitted: 0, graded: 0 });

            useEffect(() => {
                if (!isAuthReady || !db) {
                    if (isAuthReady && !db) setError("Database service unavailable.");
                    setIsLoading(false); return;
                }
                setIsLoading(true);
                
                // Listener for overall stats
                const allSubmissionsQuery = collection(db, `artifacts/${appId}/public/data/submissions`);
                const unsubscribeStats = onSnapshot(allSubmissionsQuery, (allDocsSnapshot) => {
                    let sCount = 0, gCount = 0;
                    allDocsSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'submitted') sCount++;
                        if (data.status === 'graded') gCount++;
                    });
                    setStats({ total: allDocsSnapshot.size, submitted: sCount, graded: gCount });
                }, (err) => console.error("Error fetching all submissions for stats:", err));

                // Listener for filtered submissions
                let submissionsQuery = filterStatus === 'all' ? 
                    collection(db, `artifacts/${appId}/public/data/submissions`) :
                    query(collection(db, `artifacts/${appId}/public/data/submissions`), where("status", "==", filterStatus));
                
                const unsubscribeSubmissions = onSnapshot(submissionsQuery, (querySnapshot) => {
                    const subs = [];
                    querySnapshot.forEach((doc) => subs.push({ id: doc.id, ...doc.data() }));
                    subs.sort((a, b) => (b.submittedAt?.toDate()?.getTime() || 0) - (a.submittedAt?.toDate()?.getTime() || 0));
                    setSubmissions(subs);
                    setIsLoading(false); setError(null);
                }, (err) => { console.error("Error fetching submissions for grader:", err); setError("Failed to load submissions."); setIsLoading(false); });

                return () => { 
                    unsubscribeStats();
                    unsubscribeSubmissions();
                };
            }, [filterStatus, isAuthReady, db, appId]); 

            const openGradingModal = (submission) => { setSelectedSubmission(submission); setIsGradingModalOpen(true); };
            const closeGradingModal = () => { setSelectedSubmission(null); setIsGradingModalOpen(false); };

            if (!isAuthReady || !db) return (<div className="text-center p-10"><div className="mb-4"><Spinner size={32} /></div><p className="text-gray-600 dark:text-gray-300">Waiting for essential services...</p></div>);

            return (
                <div className="space-y-6 md:space-y-8 animate-fade-in">
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 p-4 bg-white dark:bg-gray-800 shadow rounded-lg">
                        <div>
                            <h2 className="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Grading Console</h2>
                             <p className="text-gray-600 dark:text-gray-400 text-sm mt-1">Viewing: <span className="font-semibold capitalize">{filterStatus}</span> submissions. ({submissions.length} items shown)</p>
                        </div>
                        <div className="flex items-center space-x-3">
                            <label htmlFor="filterStatus" className="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">Filter by:</label>
                            <select id="filterStatus" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100 text-sm transition-colors">
                                <option value="submitted">To Grade ({stats.submitted})</option>
                                <option value="graded">Graded ({stats.graded})</option>
                                <option value="all">All Submissions ({stats.total})</option>
                            </select>
                        </div>
                    </header>
                    {isLoading && <div className="text-center py-10"><Spinner size={32} /></div>}
                    {error && (<div className="text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900 p-4 rounded-lg shadow text-center">{error}</div>)}
                    {!isLoading && !error && submissions.length === 0 && (
                        <div className="text-center py-16 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                            <div className="text-gray-400 dark:text-gray-500 mb-6"><svg xmlns="http://www.w3.org/2000/svg" className="h-20 w-20 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg></div>
                            <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">{filterStatus === 'graded' ? 'No graded submissions' : filterStatus === 'submitted' ? 'All caught up!' : 'No submissions found.'}</h3>
                            <p className="text-gray-600 dark:text-gray-400 max-w-md mx-auto">{filterStatus === 'graded' ? 'Graded submissions appear here.' : filterStatus === 'submitted' ? 'New student submissions will appear here.' : 'No submissions match filter.'}</p>
                        </div>
                    )}
                    {!isLoading && !error && submissions.length > 0 && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 md:gap-6">
                            {submissions.map(sub => (
                                <div key={sub.id} className="bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl rounded-xl p-5 border border-gray-200 dark:border-gray-700 transition-all flex flex-col justify-between">
                                    <div>
                                        <div className="flex justify-between items-start mb-3"><h4 className="font-semibold text-lg text-indigo-600 dark:text-indigo-400 truncate" title={sub.assignmentTitle}>{sub.assignmentTitle}</h4><StatusBadge status={sub.status} /></div>
                                        <p className="text-sm text-gray-700 dark:text-gray-300 mt-1 truncate" title={sub.studentEmail || sub.studentId}>Student: <span className="font-medium">{sub.studentEmail || sub.studentId}</span></p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Cert. Name: <span className="font-medium">{sub.fullNameForCertificate || 'N/A'}</span></p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Submitted: {sub.submittedAt?.toDate() ? new Date(sub.submittedAt.toDate()).toLocaleString(undefined, {dateStyle: 'medium', timeStyle: 'short'}) : 'N/A'}</p>
                                        {sub.gradedAt && (<p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Graded: {sub.gradedAt?.toDate() ? new Date(sub.gradedAt.toDate()).toLocaleString(undefined, {dateStyle: 'medium', timeStyle: 'short'}) : 'N/A'}</p>)}
                                        <p className="text-sm text-gray-600 dark:text-gray-300 truncate mt-2"><span className="font-medium">Link:</span> <a href={sub.notebookLink} target="_blank" rel="noopener noreferrer" className="text-blue-500 dark:text-blue-300 hover:underline" title={sub.notebookLink}>View Notebook</a></p>
                                    </div>
                                    <div className="mt-5 pt-4 border-t border-gray-200 dark:border-gray-700">
                                        {sub.status === 'graded' ? (
                                            <div className="space-y-2">
                                                <p className="text-xl font-bold text-green-600 dark:text-green-400 text-center">Grade: {sub.grade}</p>
                                                {sub.certificateEligible && parseFloat(sub.grade) >= 50 && (<p className="text-xs text-center text-purple-600 dark:text-purple-400">Certificate Eligible</p>)}
                                                <button onClick={() => openGradingModal(sub)} className="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-sm transition-colors text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400" aria-label={`Edit Grade for ${sub.assignmentTitle}`}>View/Edit Grade</button>
                                            </div>
                                        ) : (<button onClick={() => openGradingModal(sub)} className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-sm transition-colors text-sm focus:outline-none focus:ring-2 focus:ring-green-500" aria-label={`Grade ${sub.assignmentTitle}`}>Grade Notebook</button>)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {selectedSubmission && (<GradingModal isOpen={isGradingModalOpen} onClose={closeGradingModal} submission={selectedSubmission} graderId={userId} appId={appId} db={db} />)}
                </div>
            );
        };

        // Grading Modal
        const GradingModal = ({ isOpen, onClose, submission, graderId, appId, db }) => { 
            const [grade, setGrade] = useState('');
            const [feedback, setFeedback] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            const [error, setError] = useState(null);
            const [successMessage, setSuccessMessage] = useState(null);
            const gradeInputRef = useRef(null);
            useEffect(() => {
                if (submission) { setGrade(submission.grade || ''); setFeedback(submission.feedback || ''); if (isOpen) { setTimeout(() => gradeInputRef.current?.focus(), 100); }}
                setError(null); setSuccessMessage(null);
            }, [submission, isOpen]);

            const handleSaveGrade = async () => {
                setError(null);
                if (!grade.toString().trim()) { setError("Grade is required."); return; }
                const numericGrade = parseFloat(grade);
                if (isNaN(numericGrade)) { setError("Grade must be a number."); return; }
                if (!db) { setError("Database service unavailable."); return; }
                setIsSaving(true); setSuccessMessage(null);
                const certificateEligible = numericGrade >= 50;
                try {
                    const submissionRef = doc(db, `artifacts/${appId}/public/data/submissions/${submission.id}`);
                    await updateDoc(submissionRef, {
                        grade: numericGrade.toString(), feedback: feedback.trim(), status: 'graded',
                        gradedAt: serverTimestamp(), gradedBy: graderId, certificateEligible: certificateEligible,
                    });
                    let message = "Grade saved successfully!";
                    if (certificateEligible) message += ` Student is eligible for a certificate.`;
                    else message += ` Student is NOT eligible for a certificate (Grade < 50).`;
                    setSuccessMessage(message);
                } catch (err) { console.error("Error saving grade:", err); setError(`Failed to save grade: ${err.message}.`); }
                setIsSaving(false);
            };
            
            const generateEmailPreview = () => {
                if (!submission) return "";
                const numericGrade = parseFloat(grade);
                const certEligible = numericGrade >= 50;
                let emailBody = `To: ${submission.studentEmail || submission.studentId}\nFrom: Notebook Grading Platform <noreply@example.com>\nSubject: Your Grade for "${submission.assignmentTitle}" is Available!\n\nHi ${submission.fullNameForCertificate || submission.studentEmail?.split('@')[0] || 'Student'},\n\nYour submission for the assignment "${submission.assignmentTitle}" has been graded.\n\nAssignment: ${submission.assignmentTitle}\nGrade: ${grade}\n\nFeedback:\n${feedback.trim() || "No specific feedback provided."}\n`;
                if (certEligible) emailBody += `\nCongratulations! Your certificate of completion is now available for download from the platform.\n`;
                else emailBody += `\nPlease review the feedback to improve for future assignments.\n`;
                emailBody += `\nView details on the platform.\n\nBest regards,\nThe Grading Team`;
                return emailBody.trim();
            };

            if (!submission) return null; 
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Grading: ${submission.assignmentTitle}`}>
                    <div className="space-y-5">
                        <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 space-y-1.5">
                            <p className="text-sm text-gray-700 dark:text-gray-300"><span className="font-medium">Student:</span> {submission.studentEmail || submission.studentId}</p>
                            <p className="text-sm text-gray-700 dark:text-gray-300"><span className="font-medium">Cert. Name:</span> {submission.fullNameForCertificate || 'N/A'}</p>
                            <p className="text-sm text-gray-700 dark:text-gray-300"><span className="font-medium">Submitted:</span> {submission.submittedAt?.toDate() ? submission.submittedAt.toDate().toLocaleString() : 'N/A'}</p>
                            <p className="text-sm text-gray-700 dark:text-gray-300"><span className="font-medium">Notebook:</span> <a href={submission.notebookLink} target="_blank" rel="noopener noreferrer" className="text-blue-500 dark:text-blue-300 hover:underline ml-1" title="Open notebook">View Notebook &rarr;</a></p>
                        </div>
                        <div>
                            <label htmlFor="grade" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Grade (Numeric)</label>
                            <input ref={gradeInputRef} type="number" id="grade" value={grade} onChange={(e) => setGrade(e.target.value)} className="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-colors" placeholder="e.g., 85" required aria-required="true"/>
                            <p className="mt-1.5 text-xs text-gray-500 dark:text-gray-400">Grade of 50+ enables certificate eligibility.</p>
                        </div>
                        <div>
                            <label htmlFor="feedback" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Feedback</label>
                            <textarea id="feedback" value={feedback} onChange={(e) => setFeedback(e.target.value)} rows="6" className="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-colors" placeholder="Provide detailed feedback..."></textarea>
                        </div>
                        {error && <div className="text-sm text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900 p-3 rounded-lg shadow">{error}</div>}
                        {successMessage && <div className={`text-sm p-3 rounded-lg shadow ${parseFloat(grade) >= 50 ? 'text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900' : 'text-yellow-700 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900'}`}>{successMessage}</div>}
                        {successMessage && (<div className="mt-4 p-4 bg-gray-100 dark:bg-gray-700/50 border border-gray-300 dark:border-gray-600 rounded-lg"><h4 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Simulated Notification:</h4><pre className="text-xs text-gray-600 dark:text-gray-400 whitespace-pre-wrap bg-white dark:bg-gray-800 p-3 rounded shadow-sm max-h-48 overflow-auto">{generateEmailPreview()}</pre></div>)}
                        <div className="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700 mt-6">
                            <button type="button" onClick={onClose} disabled={isSaving} className="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-lg border border-gray-300 dark:border-gray-500 shadow-sm transition-colors disabled:opacity-50">Close</button>
                            <button type="button" onClick={handleSaveGrade} disabled={isSaving} className="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800 disabled:opacity-60 disabled:cursor-not-allowed min-w-[180px] flex items-center justify-center">{isSaving ? <Spinner size={20} color="border-white"/> : 'Save Grade & Notify'}</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        if (app && auth && db) {
            try {
                const root = createRoot(document.getElementById('root'));
                root.render(<StrictMode><ErrorBoundary><App /></ErrorBoundary></StrictMode>);
            } catch (error) {
                console.error("Error rendering React app:", error);
                 document.getElementById('root').innerHTML = `<div class="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6 text-center"><div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-300 px-6 py-4 rounded-lg shadow-lg max-w-md w-full"><strong class="font-bold block mb-2">Critical Rendering Error:</strong><p>The application failed to load. Please refresh.</p></div><button onclick="window.location.reload()" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md transition-all">Refresh Page</button></div>`;
            }
        }
    </script>
</body>
</html>
